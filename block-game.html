<html>
<head>
<style>
    #board-container { border: thin solid black; float: left; }
    .board { position: relative; }
    .block { position: absolute; width: 20px; height: 20px; }
    .green { background-color: green; }
    .blue { background-color: blue; }
    .red { background-color: red; }
</style>
</head>
<body>
<div id="board-container"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script src="/game-lib/block.js" type="text/javascript"></script>
<script>
(function() {
    blk.Block.onCreate.add(function(block) {
        var div = document.createElement("div");
        
        block.div = div;
        
        block.onColorChange.add(function(color) {
            var pos = this.pos();
            div.className = "block " + color;
            div.style.top = pos.row * 20;
            div.style.left = pos.col * 20;
        });
        
        block.onMove.add(function(e) {
            div.style.top = e.row * 20;
            div.style.left = e.col * 20;
        });
        
        block.onDestroy.add(function() {
            this.board.div.removeChild(div);
            div = null;
        });
        
        var pos = block.pos();
        div.className = "block " + block.color();
        div.style.top = pos.row * 20;
        div.style.left = pos.col * 20;
        block.board.div.appendChild(div);
    });
    
    blk.Board.onCreate.add(function(board) {
        board.div = document.createElement("div");
        
        $(board.div)
            .addClass("board")
            .css({ width: (20 * board.columns) + "px",
                   height: (20 * board.rows) + "px" });
    });

    var game = new blk.Game();
        
    game.onFreeze.add(function() {
        if(game.isGameOver()) { return; }
        
        game.newPiece([ Math.floor(Math.random() * game.colors.length),
                        Math.floor(Math.random() * game.colors.length),
                        Math.floor(Math.random() * game.colors.length) ]);
                        
        var loop = setInterval(function() {
            if(game.piece.isFalling) { game.piece.down(); return; }
            
            clearInterval(loop);
        }, 500);
    });
    game.onFreeze.trigger();
    
    
    $(document).keypress(function(e) {
        var code = e.keyCode || e.which;
            
        if(!game.piece.isFalling) { return; }
        
        if(code === 37) { game.piece.left(); } // LEFT
        else if(code === 38) { game.piece.rotate(); } // UP
        else if(code === 39) { game.piece.right(); } // RIGHT
        else if(code === 40) { game.piece.down(); } // DOWN
    });
    
    $("#board-container").append(game.board.div);
})();    
</script>
</body>
</html>
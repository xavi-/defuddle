<html>
<head>
<style>
    #board { position: relative; border: thin solid black; }
    .block { position: absolute; width: 20px; height: 20px; }
    .green { background-color: green; }
    .blue { background-color: blue; }
    .red { background-color: red; }
</style>
</head>
<body>
<div id="board"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script>

function Block(board, row, col, color) {
    var div = document.createElement("div");
    color = color || "";
    
    this.color = function() { 
        if(!arguments.length) { return color; }
        
        color = arguments[0];
        
        div.className = "block " + color;
        div.style.top = row * 20;
        div.style.left = col * 20;
    };
    
    this.isEmpty = false;
    
    this.pos = function() {
        if(!arguments.length) { return { row: row, col: col }; }
        
        board[row][col] = board.emptyBlock(row, col);
        if(isNaN(arguments[0])) {
            row = arguments[0].row;
            col = arguments[0].col;
        } else if(!isNaN(arguments[0]) && !isNaN(arguments[1])) {
            row = arguments[0];
            col = arguments[1];
        } else { return; }
        
        board[row][col].destroy();
        board[row][col] = this;
        
        div.style.top = row * 20;
        div.style.left = col * 20;
    };
    
    this.destroy = function() {
        if(row == null || col == null) { return; }
        
        board[row][col] = board.emptyBlock(row, col);
        board.div.removeChild(div);
        col = row = null;
        color = "";
        div = null;
        
        return true;
    };
    
    div.className = "block " + color;
    div.style.top = row * 20;
    div.style.left = col * 20;
    board.div.appendChild(div);
    
    board[row][col] = this;
}

function EmptyBlock(board, row, col) {    
    this.color = function() {
        if(!arguments.length) { return ""; }
        
        board[row][col] = new Block(board, row, col, arguments[0]);
    }
    
    this.isEmpty = true;
    
    this.pos = function() { };
    
    this.destroy = function() { return false; };
}

function Board(rows, columns, div) {
    this.div = div || document.createElement("div");

    this.rows = rows;
    this.columns = columns;
    
    this.emptyBlock = function(row, col) {
        return new EmptyBlock(this, row, col);
    };
    
    for(var r = -1; r <= rows; r++) {
        this[r] = [];
        
        for(var c = -1; c <= columns; c++) {
            this[r][c] = this.emptyBlock(r, c);
        }
    }
}

function Piece(board) {
    this.row;
    this.col;
    
    this.left = function left() {
        var row = this.row, col = this.col;
        
        if(col - 1 < 0) { return; }
        if(!board[row + 0][col - 1].isEmpty) { return; }
        if(!board[row + 1][col - 1].isEmpty) { return; }
        if(!board[row + 2][col - 1].isEmpty) { return; }
        
        board[row + 0][col].pos(row + 0, col - 1);
        board[row + 1][col].pos(row + 1, col - 1);
        board[row + 2][col].pos(row + 2, col - 1);
        
        this.col -= 1;
    };
    
    this.rotate = function rotate() { 
        var row = this.row, col = this.col;
        
        var tmp = board[row][col].color();
        board[row][col].color(board[row + 1][col].color());
        board[row + 1][col].color(board[row + 2][col].color());
        board[row + 2][col].color(tmp);
    };
    
    this.right = function right() {
        var row = this.row, col = this.col;
        
        if(col + 1 >= board.columns) { return; }
        if(!board[row + 0][col + 1].isEmpty) { return; }
        if(!board[row + 1][col + 1].isEmpty) { return; }
        if(!board[row + 2][col + 1].isEmpty) { return; }
        
        board[row + 0][col].pos(row + 0, col + 1);
        board[row + 1][col].pos(row + 1, col + 1);
        board[row + 2][col].pos(row + 2, col + 1);
        
        this.col += 1;
    };
    
    this.down = function down() {
        var row = this.row, col = this.col;
        
        if(row + 3 >= board.rows) { return; }
        if(!board[row + 3][col].isEmpty) { return; }
        
        board[row + 2][col].pos(row + 3, col);
        board[row + 1][col].pos(row + 2, col);
        board[row + 0][col].pos(row + 1, col);
        
        this.row += 1;
    };
    
    this.isMoving = false;
}

var board = new Board(15, 9, document.getElementById("board"));

var colors = ["green", "blue", "red"];

function compactBoard(board) {
    var wasCompressed = false;
    
    for(var r = board.rows - 1; r > 0; r--) {
        for(var c = 0; c < board.columns; c++) {
            if(board[r][c].isEmpty && !board[r - 1][c].isEmpty) {
                board[r - 1][c].pos(r, c);
                wasCompressed = true;
            }
        }
    }
    
    return wasCompressed;
}

function findMatches(board) {
    var scores = [];
    
    for(var r = 0; r < board.rows; r++) {
        for(var c = 0; c < board.columns; c++) {
            var tests = [ [ board[r - 1][c], board[r][c], board[r + 1][c] ],
                          [ board[r][c - 1], board[r][c], board[r][c + 1] ],
                          [ board[r - 1][c - 1], board[r][c], board[r + 1][c  + 1] ],
                          [ board[r + 1][c - 1], board[r][c], board[r - 1][c  + 1] ] ];
            
            for(var i = 0; i < tests.length; i++) {
                var score = true;
                
                if(tests[i][0].isEmpty) { continue; }
                
                for(var j = 0; j < tests[i].length - 1; j++) {
                    if(tests[i][j].color() !== tests[i][j + 1].color()) { score = false; break; }
                }
                
                if(score) { Array.prototype.push.apply(scores, tests[i]); }
            }
        }
    }
    
    for(var i = 0; i < scores.length; i++) { scores[i].destroy(); }
    
    return scores.length !== 0;
}

var piece = new Piece(board);
function createNewPiece() {
    piece.row = 0; piece.col = 4;
    board[0][4].color(colors[Math.floor(Math.random() * 3)]);
    board[1][4].color(colors[Math.floor(Math.random() * 3)]);
    board[2][4].color(colors[Math.floor(Math.random() * 3)]);
    
    piece.isMoving = true;
}

$(document).keypress(function(e) {
    var code = e.keyCode || e.which;
    
    if(!piece.isMoving) { return; }
    
    if(code === 37) { piece.left(); } // LEFT
    else if(code === 38) { piece.rotate(); } // UP
    else if(code === 39) { piece.right(); } // RIGHT
    else if(code === 40) { piece.down(); } // DOWN
});

(function() { // Game Loop
    var lastMove = (new Date()).getTime();
    
    $("#board")
        .css({ width: (20 * board.columns) + "px",
               height: (20 * board.rows) + "px" });
    
    for(var i = 0; i < 50; i++) {
        var row = Math.floor(Math.random() * board.rows);
        var col = Math.floor(Math.random() * board.columns);
        var color = colors[Math.floor(Math.random() * 3)];
        
        board[row][col].color(color);
    }
    
    window.setInterval(function gameLoop() {
        var curTime = (new Date).getTime();
        if(curTime - lastMove < 500) { return; }
        
        lastMove = curTime;
        
        var scored = false;
        var wasCompressed = compactBoard(board);
        if(!wasCompressed) { piece.isMoving = false; scored = findMatches(board); }
        if(!wasCompressed && !scored) { createNewPiece(); }
        else if(wasCompressed) { piece.row += 1; }
    }, 50);
})();
</script>
</body>
</html>
<html>
<head>
<style>
    #board { position: relative; border: thin solid black; }
    .block { position: absolute; width: 20px; height: 20px; }
    .green { background-color: green; }
    .blue { background-color: blue; }
    .red { background-color: red; }
</style>
</head>
<body>
<div id="board"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script>

function Board(rows, columns) {
    this.rows = rows;
    this.columns = columns;
    
    for(var r = -1; r <= rows; r++) {
        this[r] = [];
        
        for(var c = -1; c <= columns; c++) {
            this[r][c] = { color: null };
        }
    }
}

function compactBoard(board) {
    var wasCompressed = false;
    
    for(var r = board.rows - 1; r > 0; r--) {
        for(var c = 0; c < board.columns; c++) {
            if(!board[r][c].color && board[r - 1][c].color) {
                board[r][c].color = board[r - 1][c].color;
                board[r - 1][c].color = null;
                wasCompressed = true;
            }
        }
    }
    
    return wasCompressed;
}

function findMatches(board) {
    var scores = [];
    
    for(var r = 0; r < board.rows; r++) {
        for(var c = 0; c < board.columns; c++) {
            var tests = [ [ board[r - 1][c], board[r][c], board[r + 1][c] ],
                          [ board[r][c - 1], board[r][c], board[r][c + 1] ],
                          [ board[r - 1][c - 1], board[r][c], board[r + 1][c  + 1] ],
                          [ board[r + 1][c - 1], board[r][c], board[r - 1][c  + 1] ] ];
            
            for(var i = 0; i < tests.length; i++) {
                var score = true;
                for(var j = 0; j < tests[i].length - 1; j++) {
                    if(!tests[i][j].color || tests[i][j].color !== tests[i][j + 1].color) { 
                        score = false;
                        break;
                    }
                }
                
                if(score) { Array.prototype.push.apply(scores, tests[i]); }
            }
        }
    }
    
    for(var i = 0; i < scores.length; i++) { scores[i].color = null; }
    
    return scores.length !== 0;
}

function renderBoard(board) {
    var divB = document.getElementById("board");
    divB.innerHTML = "";
    
    var frag = document.createDocumentFragment();
    
    for(var r = 0; r < board.rows; r++) {
        for(var c = 0; c < board.columns; c++) {
            if(!board[r][c].color) { continue; }
        
            var div = document.createElement("div");
            div.style.top = (r * 20) + "px";
            div.style.left = (c * 20) + "px";
            div.className = "block " + board[r][c].color;
            frag.appendChild(div);
        }
    }
    
    divB.appendChild(frag);
}

var board = new Board(15, 9);

var colors = ["green", "blue", "red"];

function Piece(board) {
    this.row;
    this.col;
    
    this.rotate = function rotate() { 
        var row = this.row, col = this.col;
        
        var tmp = board[row + 2][col];
        board[row + 2][col] = board[row + 1][col];
        board[row + 1][col] = board[row][col];
        board[row][col] = tmp;
        
    }
}

var piece = new Piece(board);
function createNewPiece() {
    piece.row = 0; piece.col = 4;
    board[0][4].color = colors[Math.floor(Math.random() * 3)];
    board[1][4].color = colors[Math.floor(Math.random() * 3)];
    board[2][4].color = colors[Math.floor(Math.random() * 3)];
}

$(document).keyup(function(e) {
    var code = e.keyCode || e.which;
    
    if(code === 13) { piece.rotate(); }
});

(function() { // Game Loop
    var lastMove = (new Date()).getTime();
    
    $("#board")
        .css({ width: (20 * board.columns) + "px",
               height: (20 * board.rows) + "px" });
    
    for(var i = 0; i < 50; i++) {
        var row = Math.floor(Math.random() * board.rows);
        var col = Math.floor(Math.random() * board.columns);
        var color = colors[Math.floor(Math.random() * 3)];
        
        board[row][col].color = color;
    }
    
    window.setInterval(function gameLoop() {
        var curTime = (new Date).getTime();
        if(curTime - lastMove < 500) { return; }
        
        lastMove = curTime;
        
        var wasCompressed = compactBoard(board);
        var scored = false;
        if(!wasCompressed) { scored = findMatches(board); }
        if(!wasCompressed && !scored) { createNewPiece(); }
        else if(wasCompressed) { piece.row += 1; }
        
        renderBoard(board);
    }, 50);
})();
</script>
</body>
</html>
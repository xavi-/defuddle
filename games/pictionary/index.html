<!DOCTYPE html>
<html>
<meta http-equiv="X-UA-Compatible" content="IE=7" />
<head>
    <title>Pictionary</title>
    <style>
        #paper {
            border: 1px solid black;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
            width: 500px;
            height: 500px;
            position: relative;
            float: left;
        }
        
        #paper canvas {
            position: absolute;
            top: 0px;
            left: 0px;
        }
        
        iframe { float: left; height: 502px; margin-left: 2px; }
        
        #brush{ clear: both; }
    </style>
    <!--[if IE]><script type="text/javascript" src="/excanvas.js"></script><![endif]-->
</head>
<body>
    <h1>Pictionary</h1>
    <div id="paper">
        <canvas id="base" width="500" height="500" unselectable="on"></canvas>
        <canvas id="user-layer" width="500" height="500" unselectable="on"></canvas>
    </div>
    <iframe src="http://www.the-xavi.com/chat/pictionary" frameborder="0">
        You can't join the chat =(
    </iframe>
    <br/>
    <div id="brush">
        <div class="brush-color" hex-color="0000FF" style="background-color: #0000FF;">blue</div>
        <div class="brush-color" hex-color="00FF00" style="background-color: #00FF00;">green</div>
        <div class="brush-color" hex-color="000000" style="background-color: #000000;">black</div>
    </div>
    <br/>
    <a id="clear" href="404.html">Clear Board</a>
    (: file ~ ./links.html :)
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/json2.js"></script>
<script src="/client.js" type="text/javascript"></script>
<script>
$(function() { 
    var baseCtx = document.getElementById("base").getContext("2d");
    var ch = new Channel("pictionary");
    
    $("#clear").click(function() { ctx.clear(); ch.clear(); drawPoints.clear(); return false; });
    
    var drawPoints = (function() {
        var points = {};
        var timer = window.setInterval(function() {
            for(var id in points) {
                var pnt1 = points[id][0], pnt2 = points[id][1];
                
                if(pnt1 && "clear" in pnt1) { ctx.clear(); points[id].shift(); continue; }
                
                if(pnt2 && "clear" in pnt2) { ctx.clear(); points[id].shift(); points[id].shift(); continue; }
                
                if(!pnt1 || !pnt2) { continue; }
                
                var diff = (new Date()).getTime() - points[id].offset;
                if(diff < pnt2.time - pnt1.time) { continue; }
                
                brush = parseBrush(pnt1.brush);
                ctx.strokeStyle = brush.rgba;
                ctx.lineWidth = brush.width;
                ctx.beginPath();
                ctx.moveTo(pnt1.x, pnt1.y);
                ctx.lineTo(pnt2.x, pnt2.y);
                ctx.stroke();
                
                points[id].shift();
                if(points[id][0].end) { points[id].shift(); }
                
                if(points[id].length === 0) { delete points[id]; }
                else { points[id].offset += diff; }
            }
        }, 20);
        
        function drawPoints(data) {
            if(!data || !data.content) { return; }
            
            var id = data.userId, content = data.content;
            points[id] = points[id] || [];
            
            if("clear" in data.content) { points[id].push(data.content); return; }
            
            if(data.content.length < 2) { return; }
                        
            var offset = -content[0].time;
            if(points[id].length > 0) { offset = points[id][points[id].length - 1].time; }            
            for(var i = 0; i < content.length; i++) { content[i].time += offset }
            
            Array.prototype.push.apply(points[id], content);
            
            if(!points[id].offset) { points[id].offset = (new Date()).getTime(); }
        };
        
        drawPoints.clear = function() { points = {}; };
        
        return function() { }; //drawPoints;
    })();
    ch.onReceive(drawPoints);
    
    var sendPoint = (function() {
        var points = [], lastTime = 0;
        function sendPoint(x, y, brushNum, forced) {
            var curTime = (new Date()).getTime();
            
            points.push({ x: +x >> 0, y: +y >> 0, "brush": brushNum,
                          time: (curTime - lastTime) % 10000, end: forced });
            
            if(!forced && curTime - lastTime < 250) { return; }
            lastTime = curTime;
            
            if(points.length < 2) { return; }
            
            ch.send(points);
            points.length = 0;
        };
        
        return function() { };
    })();
    
    var DrawLayer = (function() {        
        function parseBrush(number) {
            number = +number;
            
            var brush = { red: (number & 0x00FF0000) >> 16,
                          green: (number & 0x0000FF00) >> 8,
                          blue: (number & 0x000000FF) >> 0,
                          alpha: ((number & 0x0F000000) >> 24) / 0x0F,
                          width: ((number & 0xF0000000) >>> 28) };
            brush.rgba = ["rgba(", brush.red, ", ", brush.green, ", ", brush.blue, ", ", 0.3, ")" ].join("");
            
            return brush;
        }
        
        function createEvent(ctx) {
            var listeners = [], addObj = { add: add };
            
            function add(listener) { listeners.push(listener); return addObj; };
            
            add.trigger = function trigger(e) {
                for(var i = 0; i < listeners.length; i++) { listeners[i].apply(ctx, arguments); }
            };
            
            return add;
        }
    
        return function DrawLayer(ctx) {
            var points = [];
            
            ctx.lineCap = "round";
            ctx.clear = function() { this.clearRect(0, 0, 500, 500); };
            
            this.start = function(x, y, brush) {
                var brush = parseBrush(brushNum);
                ctx.strokeStyle = brush.rgba;
                ctx.lineWidth = brush.width;
                
                points = [ { x: x >> 0, y: y >> 0 } ];
            };
            
            this.addPoint = function(x, y) {
                points.push({ x: x >> 0, y: y  >> 0 });
                
                ctx.clear();
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                
                for(var i = 0; i < points.length; i++) {
                    ctx.lineJoin = "round";
                    ctx.lineTo(points[i].x, points[i].y);
                }
                
                ctx.stroke();
            };
            
            this.end = function(x, y) {
                this.addPoint(x, y);
                this.onEnd.trigger(points, ctx);
            };
            
            this.onEnd = createEvent(this);
        };
    })();
    
    var userLayer = new DrawLayer(document.getElementById("user-layer").getContext("2d"));
    userLayer.onEnd(function(points, ctx) {
        var data = document.getElementById("user-layer").toDataURL("image/png");
        
        var img = document.createElement("img");
        img.onload = function() { ctx.clear(); baseCtx.drawImage(img, 0, 0); };
        img.src = data;
    });
    
    var paper = document.getElementById("paper");
    var isMouseDown = false, basePos = $(paper).offset(), lastPnt;
    $(document)
        .mousedown(function(e) {
            isMouseDown = (e.target == paper || $.contains(paper, e.target));
            
            if(isMouseDown) {
                var x = e.pageX - basePos.left, y = e.pageY - basePos.top;
                
                userLayer.start(x, y, brushNum);
                sendPoint(x, y, brushNum);
                lastPnt = { x: x, y: y, time: (new Date()).getTime() };
            }
        })
        .mousemove(function(e) {
            if(!isMouseDown) { return; }
            
            var curTime = (new Date()).getTime();
            
            if(curTime - lastPnt.time < 20) { return; }
            
            var x = e.pageX - basePos.left, y = e.pageY - basePos.top;
            
            userLayer.addPoint(x, y);
            sendPoint(x, y, brushNum);
            lastPnt = { x: x, y: y, time: curTime };
        })
        .mouseup(function(e) {
            if(isMouseDown) {
                var x = e.pageX - basePos.left, y = e.pageY - basePos.top;
                
                userLayer.end(x, y);
                sendPoint(x, y, brushNum, true);
            }
            
            isMouseDown = false;
        });
        
    var brushNum = 0xAA000000;
    $("#brush").delegate(".brush-color", "click", function() {
        brushNum = 0xAA000000 | parseInt($(this).attr("hex-color"), 16);
        console.log("color: " + brushNum);
    });
    
    ch.start();
});
</script>
</body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Pictionary</title>
    <style>
        #paper { border: 1px solid black; }
        iframe { border: none; height: 502px; }
    </style>
</head>
<body>
    Hello hi<br/>
    <canvas id="paper" width="500" height="500"></canvas>
    <iframe src="http://www.the-xavi.com/chat/pictionary">
        You can't join the chat =(
    </iframe>
    <br/>
    <a id="clear" href="404.html">Clear Board</a>
<script src="/client.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script>
$(function() { 
    var paper = document.getElementById("paper");
    var ctx = paper.getContext("2d");
    var ch = new Channel("pictionary");
    
    ctx.clear = function() { this.clearRect(0, 0, 500, 500); };
    
    $("#clear").click(function() { ctx.clear(); ch.clear(); return false; });
    
    var drawPoints = (function() {
        var points = {};
        var timer = window.setInterval(function() {
            for(var id in points) {
                var pnts = points[id];
                
                if(pnts[0] && "clear" in pnts[0]) { ctx.clear(); points[id].shift(); }
                
                if(pnts.length < 2) { continue; }
                
                var diff = (new Date()).getTime() - points[id].offset;
                if(diff < pnts[1].time - pnts[0].time) { continue; }
                
                ctx.beginPath();
                ctx.moveTo(pnts[0].x, pnts[0].y);
                ctx.lineTo(pnts[1].x, pnts[1].y);
                ctx.stroke();
                
                points[id].shift();
                if(points[id][0].end) { points[id].shift(); }
                
                if(pnts.length === 0) { delete points[id]; }
                else { points[id].offset += diff; }
            }
        }, 20);
        
        return function drawPoints(data) {
            if(!data || !data.content) { return; }
            
            var id = data.userId, content = data.content;
            points[id] = points[id] || [];
            
            if("clear" in data.content) { points[id].push(data.content); return; }
            
            if(data.content.length < 2) { return; }
                        
            var offset = -content[0].time;
            if(points[id].length > 0) { offset = points[id][points[id].length - 1].time; }            
            for(var i = 0; i < content.length; i++) { content[i].time += offset }
            
            Array.prototype.push.apply(points[id], content);
            
            if(!points[id].offset) { points[id].offset = (new Date()).getTime(); }
        };
    })();
    ch.addListener(drawPoints);
    
    var sendPoint = (function() {
        var points = [], lastTime = 0;
        return function sendPoint(x, y, forced) {
            var curTime = (new Date()).getTime();
            
            points.push({ x: x, y: y, time: (curTime - lastTime) % 10000, end: forced });
            
            if(!forced && curTime - lastTime < 250) { return; }
            lastTime = curTime;
            
            if(points.length < 2) { return; }
            
            ch.send(points);
            points.length = 0;
        };
    })();
    
    var isMouseDown = false, basePos = $(paper).offset(), lastPnt;
    $(document)
        .mousedown(function(e) {
            isMouseDown = (e.target == paper);
            
            if(isMouseDown) {
                var x = e.pageX - basePos.left, y = e.pageY - basePos.top;
                
                sendPoint(x, y);
                lastPnt = { x: x, y: y, time: (new Date()).getTime() };
            }
        })
        .mousemove(function(e) {
            if(!isMouseDown) { return; }
            
            var curTime = (new Date()).getTime();
            
            if(curTime - lastPnt.time < 20) { return; }
            
            var x = e.pageX - basePos.left, y = e.pageY - basePos.top;
            
            ctx.beginPath();
            ctx.moveTo(lastPnt.x, lastPnt.y);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            sendPoint(x, y);
            lastPnt = { x: x, y: y, time: curTime };
        })
        .mouseup(function(e) {
            if(isMouseDown) {
                var x = e.pageX - basePos.left, y = e.pageY - basePos.top;
                
                ctx.beginPath();
                ctx.moveTo(lastPnt.x, lastPnt.y);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                sendPoint(x, y, true);
            }
            
            isMouseDown = false;
        });
    
    ch.start();
});
</script>
</body>
</html>
<html>
<head>
<style>
    #board {
        width: 400px;
        height: 400px;
        border: 1px solid black;
    }
    
    .piece {
        position: absolute;
        background-color: blue;
        text-align: center;
    }
</style>
</head>
<body>
    <div id="board"></div>
    <span id="player-status"></span>
    <br/>
    <a id="new-game" href="404.html">New Game</a>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script src="/client.js" type="text/javascript"></script>
<script type="text/javascript" src="hexlib/src/hex.js"></script>
<script src="/game-lib/kung-fu-chess.js" type="text/javascript"></script>
<script type="text/javascript">
(function() {
    var grid = hex.grid(document.getElementById("board"), { type: "rectangular" });
    var region = hex.region(grid, { inside: function(x, y) { return x >= 0 && x < 8 && y >= 0 && y < 8; } });

    var ch = new Channel("kung-fu-chess");
    
    kfc.Piece.onCreate.add(function(piece) {
        var div = document.createElement("div");
        
        div.className = "piece";
        div.style.width = grid.tileWidth + "px";
        div.style.height = grid.tileHeight + "px";
        div.innerHTML = piece.type + "<br/>" + piece.color;
        
        piece.div = div;
        piece.board.grid.root.appendChild(div);
        
        piece.onMove.add(function(e) {
            var pos = grid.screenpos(e.newPos.col, e.newPos.row);
            div.style.left = pos.x + "px";
            div.style.top = pos.y + "px";
            
            if(e.source === "user") { ch.send({ move: { from: e.oldPos, to: e.newPos } }); }
        });
        
        piece.onDestroy.add(function(e) {
            div.parentNode.removeChild(div);
        });
    });
    
    kfc.Board.onCreate.add(function(board) {
        board.grid = grid;
    });
    
    kfc.Game.onCreate.add(function(game) {
        var selectedPiece;
        
        game.board.grid.addEvent("tiledown", function(e, x, y) {
            e.preventDefault();
            
            var piece = game.board[y][x];
            if(!piece.isEmpty && (new Date()) - piece.lastMoved >= 5000) { selectedPiece = piece; }
        });
        
        game.board.grid.addEvent("tileup", function(e, x, y) {
            e.preventDefault();
            
            if(!selectedPiece) { return; }
            
            if(x > 7 || x < 0 || y > 7 || y < 0) { return; }
            
            if(game.player !== selectedPiece.color) { return; }
            
            if(selectedPiece.isValidMove(y, x)) { 
                selectedPiece.pos(y, x, "user");
                selectedPiece = null; 
            }
        });
    });
    
    grid.reorient(0, grid.tileHeight * 7);
    var game = new kfc.Game();
    
    ch.onReceive(function(msg) {
        if("clear" in msg.content) {
            game.reset();
        } else if("new-game" in msg.content) {
            game.player = msg.content["new-game"][ch.userId()];
            
            if(game.player) { $("#player-status").text("You're are " + game.player); }
            else { $("#player-status").text("Sorry you're not playing..."); }
        } else if("move" in msg.content) {
            var from = msg.content["move"].from, to = msg.content["move"].to;
            
            game.board[from.row][from.col].pos(to.row, to.col);
        }
    });
    
    ch.start();
    
    $("#new-game").click(function() { ch.clear(); game.reset(); return false; });
})();
</script>
</body>
</html>
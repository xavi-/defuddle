<html>
<head>
<style>
    .cell {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 5px solid black;
        font-size: 34px;
        text-align: center;
    }
    
    .board {
        position: relative;
        width: 150px;
        height: 150px;
    }
</style>
</head>
<body>
    <div id="board"></div>
    <a id="clear" href="404.html">Clear Board</a>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script src="/client.js" type="text/javascript"></script>
<script>
(function() {
    function Event(ctx) {
        var listeners = [];
        
        this.add = function(listener) { listeners.push(listener); };
        
        this.trigger = function trigger(e) {
            for(var i = 0; i < listeners.length; i++) { listeners[i].call(ctx, e, ctx); }
        };
    }

    function Cell(board, row, col) {
        var symbol = null;
        
        this.div = document.createElement("div");
        
        this.row = row;
        
        this.col = col;
        
        this.isSelected = false;
        
        this.symbol = function() {
            if(arguments.length === 0) { return symbol; }
            
            if(this.isSelected) { return; }
            var fireTrigger = arguments.length === 1 || arguments[1];
            
            symbol = arguments[0];
            this.isSelected = true;
            this.div.innerHTML = symbol;
            if(fireTrigger) { this.onSelected.trigger(symbol); }
        };
        
        this.onSelected = new Event(this);
        
        this.div.className = "cell";
        this.div.style.top = (row * 50) + "px";
        this.div.style.left = (col * 50) + "px";
        board.div.appendChild(this.div);
    }
    
    function Board(div) {
        this.div = div || document.createElement("div");
        
        for(var r = 0; r < 3; r++) {
            this[r] = [];
            
            for(var c = 0; c < 3; c++) { this[r][c] = new Cell(this, r, c); }
        }
        
        this.div.className = "board";
    }
    
    var Game = (function() {
        function Game(board) {
            
            this.board = board;
            
            this.turn = "X";
            
            this.onPlacement = new Event(this);
            
            var game = this;
            function piecePlaced() {
                game.onPlacement.trigger(this);
                game.turn = (game.turn === "X") ? "O" : "X";
            }
            for(var r = 0; r < 3; r++) {
                for(var c = 0; c < 3; c++) {
                    board[r][c].onSelected.add(piecePlaced);
                
                    $(board[r][c].div).click((function(board, row, col, game) {
                        return function() { board[row][col].symbol(game.turn); }
                    })(board, r, c, this));
                }
            }
        }
        
        Game.prototype.isGameOver = function() {
            var tests = [ [ this.board[0][0].symbol(), this.board[0][1].symbol(), this.board[0][2].symbol() ],
                          [ this.board[1][0].symbol(), this.board[1][1].symbol(), this.board[1][2].symbol() ],
                          [ this.board[2][0].symbol(), this.board[2][1].symbol(), this.board[2][2].symbol() ],
                          [ this.board[0][0].symbol(), this.board[1][0].symbol(), this.board[2][0].symbol() ],
                          [ this.board[0][1].symbol(), this.board[1][1].symbol(), this.board[2][1].symbol() ],
                          [ this.board[0][2].symbol(), this.board[1][2].symbol(), this.board[2][2].symbol() ],
                          [ this.board[0][0].symbol(), this.board[1][1].symbol(), this.board[2][2].symbol() ],
                          [ this.board[0][2].symbol(), this.board[1][1].symbol(), this.board[2][0].symbol() ] ];
            
            var hasEmptyCell = false, winner = null;
            for(var t = 0; t < tests.length; t++) {
                var test = tests[t];
                hasEmptyCell = hasEmptyCell || !test[0] || !test[1] || !test[2];
                
                if(test[0] && test[0] == test[1] && test[1] == test[2]) { winner = test[0]; break; }
            }
            
            return winner || !hasEmptyCell;
        };
        return Game;
    })();
    
    var ch = new Channel("tic-tac-toe");
    var game = new Game(new Board(document.getElementById("board")));
    game.onPlacement.add(function(e) {
        ch.send({ turn: this.turn, row: e.row, col: e.col });
    });
    ch.addListener(function(msg) {
        if("clear" in msg.content) { return; }
        game.board[msg.content.row][msg.content.col].symbol(msg.content.turn, false);
    });
    
    $("#clear").click(function() { ch.clear(); return false; });
    
    ch.start();
})();
</script>
</body>
</html>
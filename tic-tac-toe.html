<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<style>
    .cell {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 5px solid black;
        font-size: 34px;
        text-align: center;
        z-index: 1;
    }
    
    .board {
        position: relative;
        width: 150px;
        height: 150px;
        z-index: 0;
    }
    
    .disable-cover {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 100;
        top: 0px;
        left: 0px;
    }
</style>
</head>
<body>
    <span id="turn-status"></span>
    <div id="board"></div>
    <a id="clear" href="404.html">Clear Board</a>
    <br/>
    <span id="player-status"></span>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script src="/client.js" type="text/javascript"></script>
<script>
(function() {
    function Event(ctx) {
        var listeners = [];
        
        this.add = function(listener) { listeners.push(listener); };
        
        this.trigger = function trigger(e) {
            for(var i = 0; i < listeners.length; i++) { listeners[i].call(ctx, e, ctx); }
        };
    }

    function Cell(board, row, col) {
        var symbol = null;
        
        this.div = document.createElement("div");
        
        this.row = row;
        
        this.col = col;
        
        this.symbol = function() {
            if(arguments.length === 0) { return symbol; }
            
            symbol = arguments[0];
            this.div.innerHTML = symbol || "";
            this.onChange.trigger({ symbol: symbol, source: arguments[1] });
        };
        
        this.onChange = new Event(this);
        
        this.div.className = "cell";
        this.div.style.top = (row * 50) + "px";
        this.div.style.left = (col * 50) + "px";
        board.div.appendChild(this.div);
    }
    
    function Board(div) {
        this.div = div || document.createElement("div");
        
        for(var r = 0; r < 3; r++) {
            this[r] = [];
            
            for(var c = 0; c < 3; c++) { this[r][c] = new Cell(this, r, c); }
        }
        
        this.div.className = "board";
    }
    
    var Game = (function() {    
        function updateTurns(e) {
            this.whosTurn = this.whosNext;
            this.whosNext = (this.whosTurn === "X") ? "O" : "X";
            if(this.player === this.whosTurn) { this.enable(); } else { this.disable(); }
        }
    
        function Game(board) {
            
            this.board = board;
            
            this.whosTurn = "";
            
            this.whosNext = "X";
                        
            this.onReset = new Event(this);
                        
            this.onPlacement = new Event(this);
            
            for(var r = 0; r < 3; r++) {
                for(var c = 0; c < 3; c++) {
                    board[r][c].onChange.add((function(game) { 
                        return function(e) {
                            if(e.source === "reset") { return; }
                            game.onPlacement.trigger({cell: this, source: e.source });
                            updateTurns.call(game);
                        };
                    })(this));
                
                    $(board[r][c].div).click((function(board, row, col, game) {
                        return function() { board[row][col].symbol(game.whosTurn, "user"); };
                    })(board, r, c, this));
                }
            }
        }
        
        Game.prototype.disable = function() {
            if($(this.board.div).find(".disable-cover").length > 0) { return; }
            $("<div/>").addClass("disable-cover").appendTo(this.board.div);
        };
        
        Game.prototype.enable = function() {
            $(this.board.div).find(".disable-cover").remove();
        };
        
        
        Game.prototype.reset = function() {
            this.whosTurn = "";
            this.whosNext = "X";
            
            for(var i = 0; i < 3; i++) {
                for(var j = 0; j < 3; j++) { this.board[i][j].symbol(null, "reset"); }
            }
            
            updateTurns.call(this);
            this.onReset.trigger();
        };
        
        Game.prototype.isGameOver = function() {
            var tests = [ [ this.board[0][0].symbol(), this.board[0][1].symbol(), this.board[0][2].symbol() ],
                          [ this.board[1][0].symbol(), this.board[1][1].symbol(), this.board[1][2].symbol() ],
                          [ this.board[2][0].symbol(), this.board[2][1].symbol(), this.board[2][2].symbol() ],
                          [ this.board[0][0].symbol(), this.board[1][0].symbol(), this.board[2][0].symbol() ],
                          [ this.board[0][1].symbol(), this.board[1][1].symbol(), this.board[2][1].symbol() ],
                          [ this.board[0][2].symbol(), this.board[1][2].symbol(), this.board[2][2].symbol() ],
                          [ this.board[0][0].symbol(), this.board[1][1].symbol(), this.board[2][2].symbol() ],
                          [ this.board[0][2].symbol(), this.board[1][1].symbol(), this.board[2][0].symbol() ] ];
            
            var hasEmptyCell = false, winner = null;
            for(var t = 0; t < tests.length; t++) {
                var test = tests[t];
                hasEmptyCell = hasEmptyCell || !test[0] || !test[1] || !test[2];
                
                if(test[0] && test[0] == test[1] && test[1] == test[2]) { winner = test[0]; break; }
            }
            
            return winner || !hasEmptyCell;
        };
        
        return Game;
    })();
    
    var ch = new Channel("tic-tac-toe");
    var game = new Game(new Board(document.getElementById("board")));
    game.onReset.add(function() { $("#turn-status").text("It's " + this.whosTurn + " turn."); });
    game.onPlacement.add(function(e) {
        if(e.source === "user") { ch.send({ turn: this.whosTurn, row: e.cell.row, col: e.cell.col }); }
        
        $("#turn-status").text("It's " + this.whosNext + " turn.");
    });
    ch.addListener(function(msg) {
        if("clear" in msg.content) { game.reset(); return; }
        
        if("new-game" in msg.content) {
            var info = msg.content["new-game"];
            
            game.enable();
            if(info.x === ch.userId()) { $("#player-status").text("You're player X"); game.player = "X"; }
            else if(info.o === ch.userId()) { $("#player-status").text("You're plalyer O"); game.player = "O"; }
            else { $("#player-status").text("Sorry you're not a player..."); game.player = null; }
            if(game.player !== "X") { game.disable(); }
            
            return;
        }
        
        game.board[msg.content.row][msg.content.col].symbol(msg.content.turn, "server");
    });
    
    $("#clear").click(function() { ch.clear(); game.reset(); return false; });
    
    ch.start();
})();
</script>
</body>
</html>